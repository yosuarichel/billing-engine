# Project README

> **Project**: Loan Billing Engine (Go Microservice with Kitex RPC + HTTP)

## Overview

This project is a **loan billing engine** implemented as a Go-based microservice. Its primary job is to:

* Generate a loan schedule for a given loan (when and how much to pay).
* Provide the outstanding amount for a given loan.
* Determine whether the customer is **delinquent** (missed payments).

We offer loans of **Rp 5,000,000** over **50 weeks** with a flat annual interest rate of **10%**. The billing engine provides a repayment schedule (weekly installments, e.g., Rp 110,000 per week).

The system tracks repayments, calculates outstanding balances, and determines delinquency (customers missing 2 continuous weekly repayments are marked as delinquent). Customers must also cover missed payments (e.g., if 2 weeks are missed, they must pay 2 installments to catch up).

---

## Core Features

* **Repayment Schedule**: Generate 50-week repayment schedule with flat interest.
* **Outstanding Balance Tracking**: Keep track of remaining balance as payments are made.
* **Delinquency Tracking**: Borrowers who miss 2 consecutive repayments are flagged delinquent.
* **RPC API** (via Kitex) and **HTTP API** (with Postman collection included).
* **Database Persistence** with PostgreSQL.
* **Message Queue Integration** with NSQ.

---

## Supported Methods

* **GetOutstanding**: Returns the current outstanding loan amount (0 if loan is fully paid).
* **IsDelinquent**: Returns delinquency status (true if borrower missed more than 2 consecutive repayments).
* **MakePayment**: Records repayment of a given amount.

---

## Requirements

* **Go >= 1.24.7**
* **Go Modules** enabled
* **thriftgo** (for Thrift IDL):

  ```bash
  go install github.com/cloudwego/thriftgo@latest
  ```
* **kitex** CLI:

  ```bash
  go install github.com/cloudwego/kitex/tool/cmd/kitex@latest
  ```
* **kitexcall** CLI:

  ```bash
  go install github.com/kitex-contrib/kitexcall@latest
  ```
* **Docker** or **Podman**
* **PostgreSQL**
* **NSQ** (optional)

---

## Running the Service

### 1. Start server and all dependencies

```bash
make all
```

### 2. Generate Kitex Code (if IDL changed)

```bash
make kitexgen
```

### 3. Run Migrations
Currently we do it manually by executing the sql directly in pgsql

**Customer Table**
```sql
CREATE TABLE IF NOT EXISTS customers (
    id BIGINT PRIMARY KEY, -- ID will be generated from app
    name VARCHAR(255) NOT NULL,
    phone_number VARCHAR(50) NOT NULL,

    -- Audit Columns
    created_at TIMESTAMP NOT NULL,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP,
    updated_by VARCHAR(255),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(255)
);

-- Comments
COMMENT ON TABLE customers IS 'Stores basic customer information';
COMMENT ON COLUMN customers.id IS 'Primary key of the customer, generated by application';
COMMENT ON COLUMN customers.name IS 'Full name of the customer';
COMMENT ON COLUMN customers.phone_number IS 'Customer phone number';
COMMENT ON COLUMN customers.created_at IS 'Record creation timestamp';
COMMENT ON COLUMN customers.created_by IS 'User ID who created the record';
COMMENT ON COLUMN customers.updated_at IS 'Record last update timestamp';
COMMENT ON COLUMN customers.updated_by IS 'User ID who last updated the record';
COMMENT ON COLUMN customers.deleted_at IS 'Soft delete timestamp';
COMMENT ON COLUMN customers.deleted_by IS 'User ID who deleted the record';

-- Indexes
CREATE INDEX idx_customers_phone_number ON customers(phone_number);
CREATE INDEX idx_customers_name ON customers(name);
```

**Loans Table**
```sql
CREATE TABLE IF NOT EXISTS loans (
    id BIGINT PRIMARY KEY, -- ID will be generated from app
    customer_id BIGINT NOT NULL, -- Reference to customers.customer_id
    principal NUMERIC(15,0) NOT NULL, -- Save way to store money, e.g. 10000000 
    interest_rate NUMERIC(5,2) NOT NULL, -- percentage, e.g. 5.00 = 5%
    total_amount NUMERIC(15,0) NOT NULL, -- principal + interest
    term_weeks INT NOT NULL,
    start_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'ONGOING', -- ONGOING, PAID, DEFAULTED

    -- Audit Columns
    created_at TIMESTAMP NOT NULL,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP,
    updated_by VARCHAR(255),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(255)
);

-- Comments
COMMENT ON TABLE loans IS 'Stores loan contracts for each customer';
COMMENT ON COLUMN loans.id IS 'Primary key, generated by application';
COMMENT ON COLUMN loans.customer_id IS 'Reference to customers.customer_id';
COMMENT ON COLUMN loans.principal IS 'Loan principal amount';
COMMENT ON COLUMN loans.interest_rate IS 'Interest rate percentage';
COMMENT ON COLUMN loans.total_amount IS 'Total repayment amount including interest';
COMMENT ON COLUMN loans.term_weeks IS 'Loan duration in weeks';
COMMENT ON COLUMN loans.start_date IS 'Date when loan started';
COMMENT ON COLUMN loans.status IS 'Loan status: ONGOING, PAID, DEFAULTED';
COMMENT ON COLUMN loans.created_at IS 'Timestamp when record was created';
COMMENT ON COLUMN loans.created_by IS 'User ID who created the record';
COMMENT ON COLUMN loans.updated_at IS 'Timestamp when record was last updated';
COMMENT ON COLUMN loans.updated_by IS 'User ID who last updated the record';
COMMENT ON COLUMN loans.deleted_at IS 'Soft delete timestamp';
COMMENT ON COLUMN loans.deleted_by IS 'User ID who deleted the record';

-- Indexes
CREATE INDEX idx_loans_customer_id ON loans(customer_id);
CREATE INDEX idx_loans_status ON loans(status);
```

**Loan Schedule Table**
```sql
CREATE TABLE IF NOT EXISTS loan_schedule (
    id BIGINT PRIMARY KEY, -- ID will be generated from app
    loan_id BIGINT NOT NULL, -- Reference to loans.loan_id
    week_number INT NOT NULL,
    due_date DATE NOT NULL,
    amount NUMERIC(15,0) NOT NULL,
    is_paid BOOLEAN DEFAULT FALSE,

    -- Audit Columns
    created_at TIMESTAMP NOT NULL,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP,
    updated_by VARCHAR(255),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(255)
);

-- Comments
COMMENT ON TABLE loan_schedule IS 'Stores weekly installment schedule for each loan';
COMMENT ON COLUMN loan_schedule.id IS 'Primary key, generated by application';
COMMENT ON COLUMN loan_schedule.loan_id IS 'Reference to loans.loan_id';
COMMENT ON COLUMN loan_schedule.week_number IS 'Week number in the loan term';
COMMENT ON COLUMN loan_schedule.due_date IS 'Due date of the installment';
COMMENT ON COLUMN loan_schedule.amount IS 'Installment amount for this week';
COMMENT ON COLUMN loan_schedule.is_paid IS 'Whether this installment is paid or not';
COMMENT ON COLUMN loan_schedule.created_at IS 'Timestamp when record was created';
COMMENT ON COLUMN loan_schedule.created_by IS 'User ID who created the record';
COMMENT ON COLUMN loan_schedule.updated_at IS 'Timestamp when record was last updated';
COMMENT ON COLUMN loan_schedule.updated_by IS 'User ID who last updated the record';
COMMENT ON COLUMN loan_schedule.deleted_at IS 'Soft delete timestamp';
COMMENT ON COLUMN loan_schedule.deleted_by IS 'User ID who deleted the record';

-- Indexes
CREATE INDEX idx_schedule_loan_id ON loan_schedule(loan_id);
CREATE INDEX idx_schedule_due_date ON loan_schedule(due_date);
CREATE INDEX idx_schedule_is_paid ON loan_schedule(is_paid);
```

**Payments Table**
```sql
CREATE TABLE IF NOT EXISTS payments (
    id BIGINT PRIMARY KEY, -- ID will be generated from app
    loan_id BIGINT NOT NULL, -- Reference to loans.loan_id
    schedule_id BIGINT NOT NULL, -- Reference to loan_schedule.schedule_id
    payment_date DATE NOT NULL,
    amount NUMERIC(15,0) NOT NULL,

    -- Audit Columns
    created_at TIMESTAMP NOT NULL,
    created_by VARCHAR(255) NOT NULL,
    updated_at TIMESTAMP,
    updated_by VARCHAR(255),
    deleted_at TIMESTAMP,
    deleted_by VARCHAR(255)
);

-- Comments
COMMENT ON TABLE payments IS 'Stores payment transactions made by customers';
COMMENT ON COLUMN payments.id IS 'Primary key, generated by application';
COMMENT ON COLUMN payments.loan_id IS 'Reference to loans.loan_id';
COMMENT ON COLUMN payments.schedule_id IS 'Reference to loan_schedule.schedule_id';
COMMENT ON COLUMN payments.payment_date IS 'Date when payment was made';
COMMENT ON COLUMN payments.amount IS 'Payment amount made by customer';
COMMENT ON COLUMN payments.created_at IS 'Timestamp when record was created';
COMMENT ON COLUMN payments.created_by IS 'User ID who created the record';
COMMENT ON COLUMN payments.updated_at IS 'Timestamp when record was last updated';
COMMENT ON COLUMN payments.updated_by IS 'User ID who last updated the record';
COMMENT ON COLUMN payments.deleted_at IS 'Soft delete timestamp';
COMMENT ON COLUMN payments.deleted_by IS 'User ID who deleted the record';

-- Indexes
CREATE INDEX idx_payments_loan_id ON payments(loan_id);
CREATE INDEX idx_payments_schedule_id ON payments(schedule_id);
CREATE INDEX idx_payments_payment_date ON payments(payment_date);
```

---

## RPC Testing with **kitexcall**

1. GetOutstanding:

```bash
kitexcall --idl-path ./conf/.idl/billing_engine/billing_engine_service.thrift --method BillingEngineService/GetOutstanding --endpoint 127.0.0.1:60001 -d '{"loan_id":"38999051395417340"}'  
```

2. IsDelinquent:

```bash
kitexcall --idl-path ./conf/.idl/billing_engine/billing_engine_service.thrift --method BillingEngineService/IsDelinquent --endpoint 127.0.0.1:60001 -d '{"loan_id":"38951915102405456"}'  
```

3. MakePayment:

```bash
kitexcall --idl-path ./conf/.idl/billing_engine/billing_engine_service.thrift --method BillingEngineService/MakePayment --endpoint 127.0.0.1:60001 -d '{"loan_id":"38999051395417340", "amount":100000}'
```

4. CreateLoan:

```bash
kitexcall --idl-path ./conf/.idl/billing_engine/billing_engine_service.thrift --method BillingEngineService/CreateLoan --endpoint 127.0.0.1:60001 -d '{"customer_id":"38999017589327100","principal":5000000,"term_weeks":60}'
```

5. CreateCustomer:

```bash
kitexcall --idl-path ./conf/.idl/billing_engine/billing_engine_service.thrift --method BillingEngineService/CreateCustomer --endpoint 127.0.0.1:60001 -d '{"name":"Jane Doe Doe","phone_number":"08182938471231"}'      
```

---

## HTTP Testing with **Postman**

1. Import the collection from `./billing-engine.postman_collection.json`.
2. Import environment variables file if available.
3. Configure `baseUrl`.
4. Run requests for `GetOutstanding`, `IsDelinquent`, `MakePayment`.

---

## Example Use Case

* Create loan for Rp 5,000,000 with 50 weeks schedule.
* Borrower makes weekly payments of Rp 110,000.
* If borrower misses 2 consecutive weeks â†’ delinquent.
* Outstanding balance reduces with each payment until 0.

---

## Troubleshooting

* **Kitex GOPATH issue**: use `-module` flag or ensure `go.mod` exists.
* **DB errors**: ensure migrations applied.
* **NSQ EOF errors**: check nsqd address and config.

---

## Notes

This README reflects the **loan billing engine project context** (50-week loan, Rp 5M, 10% interest). Adjust paths and configuration files to mat
